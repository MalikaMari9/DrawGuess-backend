# HWL Fixes (2026-02-11)

This document captures the agreed fixes and merge guidance for **DrawGuess-backendHWL** (Single mode) before copying into the main backend.

---

## Locked Rules (Agreed)

1. **GM is assigned during role pick** (not the room creator).
2. **Any player can trigger the initial role pick** once minimum players are met:
   - Single: min 3
   - VS: min 5
3. **Drawer must see the secret word** (GM can see it too).
4. **Correct guess ends the round → VOTING**, then all active players vote.
5. **All active players vote**, including the GM.
6. **Explicit phases are used** (DRAW/GUESS/VOTING).
7. **New round always re-runs role pick** (GM + drawer + guessers randomly assigned again).

---

## Issues in HWL Single Mode (What Must Be Fixed)

1. **Correct guess does not end the round**
   - `handle_single_guess` emits `guess_result` but never transitions to `ROUND_END` or `VOTING`.
   - Must set room state to `ROUND_END` and move phase to `VOTING` after correct guess.

2. **Voting depends on ROUND_END but round is never set**
   - `handle_single_vote_next` assumes `header.state == "ROUND_END"`.
   - Needs correct round termination to work.

3. **Role pick flow conflicts with “GM assigned during role pick”**
   - HWL role pick is correct for SINGLE but must be aligned to the global rule:
     - GM assigned during role pick
     - Trigger can be any player, not GM-only

4. **Phase model is inconsistent**
   - Single uses phase toggling, but it doesn’t align with the VS VOTING phase.
   - Must include explicit `VOTING` phase in Single.

---

## What to Copy vs What to Rewrite

### Copy (Mostly)
- `app/domain/single/handlers.py`
  - Use as base for GM config, start round, draw/guess.
- `app/transport/protocols.py` (SINGLE message types)
  - `set_round_config`, `start_game`, `guess_chat`, `guess_result`
- `app/transport/dispatcher.py` routing for SINGLE.
- Snapshot redaction logic in lifecycle (GM + Drawer see secret).

### Rewrite / Adjust
- **Single guess flow**: must transition to `ROUND_END` + `VOTING`.
- **Voting eligibility**: all active players vote (GM included).
- **Role pick trigger**: any player can trigger initial role pick.
- **Phase enum**: ensure `VOTING` exists in all layers.
- **New round**: re-run role pick after a successful vote.

---

## Merge Checklist (No Code Yet)

1. Port SINGLE message types and events into main backend protocols.
2. Add SINGLE routing in dispatcher.
3. Port SINGLE handlers; refactor to match main repo store APIs.
4. Align role pick behavior (GM assigned during role pick).
5. Enforce round end → VOTING on correct guess.
6. Ensure vote_next includes GM and ignores inactive players.
7. Ensure role pick is re-run after vote-next YES.

---

## Suggested Prompt (for Codex/LLM)

```
We are copying SINGLE mode from DrawGuess-backendHWL into main backend.
Rules:
- GM assigned during role pick, not creator.
- Any player can trigger initial role pick once min players met.
- Correct guess ends round and moves to VOTING.
- All active players vote (GM included).
- Explicit phases DRAW/GUESS/VOTING.
- New round always re-runs role pick.

Please adjust SINGLE handlers accordingly and note any conflicts with existing VS flow.
```

