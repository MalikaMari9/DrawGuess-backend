# HWL Fixes (2026-02-11)

This document captures the agreed fixes and merge guidance for **DrawGuess-backendHWL** (Single mode) before copying into the main backend.

---

## Locked Rules (Agreed)

1. **GM is assigned during role pick** (not the room creator).
2. **Any player can trigger the initial role pick** once minimum players are met (Single: min 3, VS: min 5).
3. **Drawer must see the secret word** (GM can see it too).
4. **Correct guess ends the round → VOTING**, then all active players vote.
5. **All active players vote**, including the GM.
6. **Explicit phases are used** (DRAW/GUESS/VOTING).
7. **New round always re-runs role pick** (GM + drawer + guessers randomly assigned again).

---

## Issues in HWL Single Mode (What Must Be Fixed)

1. **Correct guess does not end the round**
   - `handle_single_guess` emits `guess_result` but never transitions to `ROUND_END` or `VOTING`.
   - Must set room state to `ROUND_END` and move phase to `VOTING` after correct guess.

2. **Voting depends on ROUND_END but round is never set**
   - `handle_single_vote_next` assumes `header.state == "ROUND_END"`.
   - Needs correct round termination to work.

3. **Role pick flow conflicts with "GM assigned during role pick"**
   - HWL role pick is correct for SINGLE but must be aligned to the global rule:
     - GM assigned during role pick
     - Trigger can be any player, not GM-only

4. **Phase model is inconsistent**
   - Single uses phase toggling, but it doesn’t align with the VS VOTING phase.
   - Must include explicit `VOTING` phase in Single.

---

## What to Copy vs What to Rewrite

### Copy (Mostly)
- `app/domain/single/handlers.py`
  - Use as base for GM config, start round, draw/guess.
- `app/transport/protocols.py` (SINGLE message types)
  - `set_round_config`, `start_game`, `guess_chat`, `guess_result`
- `app/transport/dispatcher.py` routing for SINGLE.
- Snapshot redaction logic in lifecycle (GM + Drawer see secret).

### Rewrite / Adjust
- **Single guess flow**: must transition to `ROUND_END` + `VOTING`.
- **Voting eligibility**: all active players vote (GM included).
- **Role pick trigger**: any player can trigger initial role pick.
- **Phase enum**: ensure `VOTING` exists in all layers.
- **New round**: re-run role pick after a successful vote.

---

## Merge Checklist (No Code Yet)

1. Port SINGLE message types and events into main backend protocols.
2. Add SINGLE routing in dispatcher.
3. Port SINGLE handlers; refactor to match main repo store APIs.
4. Align role pick behavior (GM assigned during role pick).
5. Enforce round end → VOTING on correct guess.
6. Ensure vote_next includes GM and ignores inactive players.
7. Ensure role pick is re-run after vote-next YES.

---

## Additional Fixes Applied (Post-merge)

- Added shared draw-op validation helper and tests.
- Added atomic Redis budget/cooldown enforcement for VS draw/sabotage.
- Added SINGLE time-limit enforcement to end rounds on timeout.
- Added SINGLE long-stroke auto-split enforcement.
- Added GM end_round support and role clearing on VOTING entry.
- Allowed SINGLE guesses during DRAW.

---

## Suggested Prompt (for Codex/LLM)

```
We are copying SINGLE mode from DrawGuess-backendHWL into main backend.
Rules:
- GM assigned during role pick, not creator.
- Any player can trigger initial role pick once min players met.
- Correct guess ends round and moves to VOTING.
- All active players vote (GM included).
- Explicit phases DRAW/GUESS/VOTING.
- New round always re-runs role pick.

Please adjust SINGLE handlers accordingly and note any conflicts with existing VS flow.
```


---

## SINGLE Project Flow (Simple)

1. Players connect and join the room.
2. Any player triggers `start_role_pick` when min 3 players are connected.
3. Server assigns GM, drawer, and guessers automatically.
4. GM sets round config (`set_round_config`).
5. GM starts game (`start_game`).
6. Phase `DRAW`: drawer sends `draw_op` (stroke limit enforced).
7. Phase `GUESS`: guessers send guesses.
8. If correct guess, round ends and phase moves to `VOTING`.
9. If time expires, round ends and moves to `VOTING`.
10. All active players vote. YES -> `ROLE_PICK` (new roles). NO/tie -> stay `ROUND_END`.

## Developer Terms (SINGLE)

**Drawer**
- The only player allowed to draw in SINGLE.

**Guesser**
- Players who can submit guesses.

**Stroke Limit**
- Max strokes per round for the drawer.

**Round Config**
- Secret word, stroke limit, and time limit set by GM.

**Phase**
- `DRAW` -> `GUESS` -> `VOTING`.
