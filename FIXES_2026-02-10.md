# DrawGuess Backend Fixes (2026-02-10)

This document summarizes the fixes applied after the VS role-pick flow was clarified as **auto-assign**.

## Summary
- VS role-pick remains **auto** and the testing guide now matches the implemented flow.
- Kicked players are now actively disconnected to stop receiving room broadcasts.
- Phase enums were normalized to include `VOTING` across layers.
- Correct-guess handling no longer sets contradictory phase values.
- Voting now includes **all active players**, including the GM, and ignores votes from inactive players.

## Code Changes (What and Where)

1. `app/store/models.py`
   - Added `VOTING` to `Phase` enum.

2. `app/domain/common/types.py`
   - Added `VOTING` to `Phase` enum.

3. `app/domain/vs/handlers_guess.py`
   - Removed the transient `phase="VOTING"` write on correct guesses.
   - Correct guesses now only update score and end the round, avoiding conflicting phase state.

4. `app/transport/ws_manager.py`
   - Added `close_pid(...)` to close a specific player's socket and remove it from the registry.

5. `app/domain/moderation/handlers.py`
   - On `kick`, the targetâ€™s socket is closed immediately via `wsman.close_pid(...)`.

6. `TESTING_GUIDE.md`
   - Updated steps to reflect **auto role assignment** on `start_role_pick`.
   - Renumbered subsequent steps.
   - Updated troubleshooting text to match the new flow.

7. `app/domain/vs/handlers_vote.py`
   - Allowed GM to vote in VOTING phase (all active players eligible).
   - Cleaned votes to ignore inactive players.
   - Rebuilt yes-vote set from current eligible votes.

## Technical Behavior Changes
- **Role Pick (VS)**: `start_role_pick` auto-assigns `drawerA`/`drawerB`, sets guessers, and moves to `CONFIG` without a manual assignment step.
- **Kick Enforcement**: Kicked players are now removed from the active connection registry and their socket is closed, so they no longer receive room broadcasts.
- **Phase Consistency**: `VOTING` is a valid phase across protocol, store models, and domain types.
- **Correct Guess Flow**: Correct guesses end the round cleanly without an intermediate `phase="VOTING"` that gets cleared in the same flow.
- **Voting Eligibility**: Any active player (including GM) can vote during `VOTING`.

## Literal / User-Facing Changes
- The testing instructions now reflect the actual UI/behavior: after `Start Role Pick`, roles are auto-assigned and the room goes directly to `CONFIG`.
- When a player is kicked, they lose the live connection immediately instead of silently staying subscribed to events.
