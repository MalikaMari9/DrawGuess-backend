# SLO Fix Notes (2026-02-15)

This document records all applied backend/frontend updates and the current VS Battle flow as of **2026-02-15**.

---

## 1. Applied Changes (Summary)

### Backend (VS)
- `DRAW -> GUESS` transition is budget-driven:
  - Happens only when **both team budgets are 0**.
  - Implemented in draw/sabotage handlers after budget update.
- `GUESS -> DRAW` loop restored for no-correct outcomes:
  - If both teams guess wrong, return to `DRAW` and refill per-phase budget.
  - If guess window expires, return to `DRAW` and refill per-phase budget.
- Round timer remains authoritative:
  - Round ends only on:
    - correct guess, or
    - `round_end_at` timeout.
- Round-end behavior:
  - On correct guess: score updates, state `ROUND_END`, phase `VOTING`, winner set.
  - On timeout: state `ROUND_END`, phase `VOTING`, no winner.
- Budget/sabotage enforcement:
  - Draw stroke cost: 1 budget (atomic Redis Lua).
  - Sabotage cost: 1 budget (`SABOTAGE_COST_STROKES = 1`) + cooldown + last-30s block.

### Frontend (Battle)
- `BattleGame.jsx` timer logic:
  - `DRAW` timer uses `round_end_at` (continuous round timer; no reset across draw/guess loop).
  - `GUESS` timer uses `guess_end_at`.
- Added periodic heartbeat from client:
  - Sends `heartbeat` every second while connected.
  - Ensures server-side timeout transitions occur reliably.
- Added one-shot snapshot pull when local phase timer reaches 0:
  - Prevents UI sticking at 0.
- Budget sync/gating fixes:
  - Drawing gates use server remaining budget (`budget.A/B`) instead of only local optimistic counters.
  - Snapshot budget is read from `game.budget`.
- Sabotage behavior fixes:
  - Armed sabotage sends to opponent canvas without incorrectly persisting stroke on own canvas.
  - Client auto-disarms sabotage on budget/cooldown errors.
- Guess submit reliability:
  - Guess input/send restricted to correct team + role + phase (`GUESS`) + connected state.
  - Guess inputs are disabled when not eligible.
- `BattleRoundWin.jsx`:
  - Added vote actions (`vote_next` yes/no) when in `ROUND_END + VOTING`.
  - Voting UI waits for server state transitions.
  - Fixed JSX parse issue (`Continue {'->'}`).

### CSS/Build Fixes
- Removed invalid mid-file `@import` declarations that broke PostCSS.
- Removed duplicate inline style keys in `BattleRoundWin.jsx` that produced Vite warnings.

---

## 2. Current VS Flow (Final)

1. Players join room.
2. Any player sends `start_role_pick` (requires at least 5 connected players).
3. Server auto-assigns GM, balances Team A/B, assigns roles, moves room to `CONFIG`.
4. GM sends `start_round` with:
   - `secret_word`
   - `time_limit_sec` (round timer)
   - `strokes_per_phase` (per DRAW phase budget)
   - `guess_window_sec`
5. Round starts in `DRAW`.
6. Drawers draw/sabotage:
   - valid draw stroke = cost 1 budget
   - sabotage = cost 1 budget + cooldown
7. When both teams have 0 budget, phase changes to `GUESS`.
8. Each team can submit one guess in that `GUESS` phase.
9. If any team guesses correctly:
   - round ends immediately
   - state `ROUND_END`, phase `VOTING`, winner + score updated
10. If no correct guess:
   - both wrong or guess window expiry -> back to `DRAW`
   - per-phase budget refilled
11. Steps 5-10 repeat until:
   - a correct guess, or
   - round timer reaches 0
12. On round timer timeout:
   - state `ROUND_END`, phase `VOTING`, no winner
13. In `VOTING`:
   - active eligible players vote (`vote_next`)
   - YES majority -> `ROLE_PICK` (new roles/next-round setup)
   - NO or tie -> remain `ROUND_END`

---

## 3. Key Files Updated (This Round)

### Backend
- `app/domain/vs/handlers_common.py`
- `app/domain/vs/handlers_draw.py`
- `app/domain/vs/handlers_sabotage.py`
- `app/domain/vs/handlers_guess.py`
- `app/domain/vs/handlers_phase.py`
- `app/domain/lifecycle/handlers.py`

### Frontend
- `src/ws/RoomWSContext.jsx`
- `src/pages/BattleGame.jsx`
- `src/pages/BattleRoundWin.jsx`
- `src/styles/landingpage.css`
- `src/styles/BattleWinFinal.css`
- `src/styles/gmSetup.css`
- `src/styles/SingleGame.css`
- `src/styles/SingleWin.css`

