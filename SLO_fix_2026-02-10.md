# SLO Fix Notes (2026-02-10)

This note is for the team member owning **team assignment**.  
Current code expects **players to choose teams** via `set_team`, but the spec says **teams should be auto-picked**.

---

## What To Fix (Summary)

**Goal:** Auto-assign players into Team A / Team B on VS role-pick (or earlier), without manual `set_team`.

### Expected Behavior
- **GM is assigned during role-pick**, not on room creation.
- Any connected player can trigger the initial role-pick.
- When VS room enters role-pick, the server auto-assigns teams.
- Teams should be balanced (e.g., alternate assignment or shuffle & split).
- GM should be excluded from teams (after GM is assigned).
- Team membership should be stored in Redis and reflected in player snapshots.

---

## Where The Fix Belongs

**Current flow (manual teams):**
- `InSetTeam` event handled in `app/domain/lobby/handlers.py`
- `repo.set_team(...)` updates Redis sets + player record

**Suggested fix point (auto teams):**
- `app/domain/lobby/handlers.py` in `handle_start_role_pick`
  - If `header.mode == "VS"`, auto-assign teams before role assignment.

---

## Implementation Notes (Suggested)

1. Fetch all connected players
2. Assign GM if none exists yet
3. Remove GM from list
4. Shuffle remaining players
5. Split into two groups (A, B)
6. Write to Redis:
   - `set_team(room_code, pid, "A")` / `set_team(room_code, pid, "B")`
7. Proceed with role auto-assignment (drawers/guessers)

Edge cases:
- If odd player count, Team A can have one extra (or alternate per round).
- If a player reconnects mid-round, they should keep existing team.

---

## Prompts You Can Use (to ask Codex/LLM)

### Prompt 1 (Minimal)
```
We want VS teams auto-assigned (no manual set_team).
Please update handle_start_role_pick to assign GM if needed, then shuffle remaining players into Team A/B,
persist teams using repo.set_team, then proceed with auto-assign roles.
Make sure snapshots show team values.
```

### Prompt 2 (Detailed)
```
In DrawGuessBackend:
Implement auto team assignment for VS mode.
On start_role_pick, assign GM if missing, then gather remaining connected players, shuffle, split into A/B.
Store to Redis via repo.set_team; update player team field.
Then auto-assign roles and move to CONFIG.
Provide a short test or sanity check for team balance.
```

### Prompt 3 (Edge Cases)
```
Please ensure auto team assignment:
- assigns GM first if missing
- skips GM after assignment
- keeps existing team if already assigned (reconnect)
- balances teams (difference <= 1)
Update handle_start_role_pick accordingly.
```

---

## Files They Should Read
- `app/domain/lobby/handlers.py` (start role pick flow)
- `app/store/redis_repo.py` (team storage)
- `app/store/redis_keys.py` (team keys)
- `app/domain/vs/roles.py` (role auto-assign)

---

## GM Aspect: Files to Fix (Backend)

These files currently assume the GM already exists or treat GM as a permanent role.  
To align with **GM assigned during role pick** and **any player can trigger initial role pick**, these should be reviewed:

1. `app/domain/lobby/handlers.py`
   - `handle_start_role_pick` should assign GM if missing.
   - The **initial** role pick should be triggerable by any connected player.

2. `app/domain/vs/handlers_start_round.py`
   - Assumes GM is already assigned and only GM can start rounds.
   - Ensure GM checks only happen **after** GM assignment step.

3. `app/domain/vs/handlers_role_pick.py`
   - Assumes GM exists and gates role assignment on GM.
   - Verify behavior if GM is assigned in the same role-pick step.

4. `app/domain/vs/handlers_phase.py`
   - Phase advancement is GM-only; ensure GM exists before enforcement.

5. `app/domain/moderation/handlers.py`
   - Moderation actions are GM-only; ensure GM exists before enforcement.

6. `app/domain/vs/handlers_vote.py`
   - Voting eligibility logic interacts with GM; ensure it matches the “GM is just a player in VOTING” rule.

7. `app/domain/lifecycle/handlers.py`
   - `create_room` sets `gm_pid=None` (correct), but any logic that assumes creator == GM should be avoided here.
