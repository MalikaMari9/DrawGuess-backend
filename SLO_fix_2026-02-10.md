# SLO Fix Notes (2026-02-10)

This note is for the team member owning **team assignment**.  
Current code expects **players to choose teams** via `set_team`, but the spec says **teams should be auto-picked**.

---

## What To Fix (Summary)

**Goal:** Auto-assign players into Team A / Team B on VS role-pick (or earlier), without manual `set_team`.

### Expected Behavior (Implemented)
- GM assigned during role-pick (not on room creation).
- Any connected player can trigger the initial role-pick.
- VS teams auto-assigned on role-pick (balanced split).
- GM excluded from teams.
- Team membership stored in Redis and reflected in snapshots.
- VS budget/cooldown enforcement made atomic via Redis Lua scripts (prevents draw/sabotage races).
- Repo-level guard prevents assigning GM to a team even if team assignment is called.
- VS guess expiry returns to DRAW; round ends only on correct guess or time limit.
- VS draw/guess/phase actions are blocked after round time limit passes.
- GM can force end_round; roles are cleared when entering VOTING.
- VS GUESS auto-expire now emits budget update when returning to DRAW.
---

## Where The Fix Belongs

**Current flow (auto teams):**
- `set_team` is disabled for VS with error `AUTO_TEAMS`.
- Teams are assigned during `handle_start_role_pick`.

**Applied fix point (auto teams):**
- `app/domain/lobby/handlers.py` in `handle_start_role_pick`
  - If `header.mode == "VS"`, auto-assign teams before role assignment.

---

## Implementation Notes (Applied)

1. Fetch all connected players
2. Assign GM if none exists yet
3. Remove GM from list
4. Shuffle remaining players
5. Split into two groups (A, B)
6. Write to Redis:
   - `set_team(room_code, pid, "A")` / `set_team(room_code, pid, "B")`
7. Proceed with role auto-assignment (drawers/guessers)

Edge cases:
- If odd player count, Team A can have one extra (or alternate per round).
- If a player reconnects mid-round, they should keep existing team.

---

## Prompts You Can Use (to ask Codex/LLM)

### Prompt 1 (Minimal)
```
We want VS teams auto-assigned (no manual set_team).
Please update handle_start_role_pick to assign GM if needed, then shuffle remaining players into Team A/B,
persist teams using repo.set_team, then proceed with auto-assign roles.
Make sure snapshots show team values.
```

### Prompt 2 (Detailed)
```
In DrawGuessBackend:
Implement auto team assignment for VS mode.
On start_role_pick, assign GM if missing, then gather remaining connected players, shuffle, split into A/B.
Store to Redis via repo.set_team; update player team field.
Then auto-assign roles and move to CONFIG.
Provide a short test or sanity check for team balance.
```

### Prompt 3 (Edge Cases)
```
Please ensure auto team assignment:
- assigns GM first if missing
- skips GM after assignment
- keeps existing team if already assigned (reconnect)
- balances teams (difference <= 1)
Update handle_start_role_pick accordingly.
```

---

## Files They Should Read
- `app/domain/lobby/handlers.py` (start role pick flow)
- `app/store/redis_repo.py` (team storage)
- `app/store/redis_keys.py` (team keys)
- `app/domain/vs/roles.py` (role auto-assign)

---

## GM Aspect: Files to Fix (Backend)

These files currently assume the GM already exists or treat GM as a permanent role.  
To align with **GM assigned during role pick** and **any player can trigger initial role pick**, these should be reviewed:

âœ… `app/domain/lobby/handlers.py`
   - GM assigned if missing.
   - Initial role pick triggerable by any connected player.
   - VS auto-teams assigned; manual `set_team` disabled.

2. `app/domain/vs/handlers_start_round.py`
   - Assumes GM is already assigned and only GM can start rounds.
   - Ensure GM checks only happen **after** GM assignment step.

3. `app/domain/vs/handlers_role_pick.py`
   - Assumes GM exists and gates role assignment on GM.
   - Verify behavior if GM is assigned in the same role-pick step.

4. `app/domain/vs/handlers_phase.py`
   - Phase advancement is GM-only; ensure GM exists before enforcement.

5. `app/domain/moderation/handlers.py`
   - Moderation actions are GM-only; ensure GM exists before enforcement.

6. `app/domain/vs/handlers_vote.py`
   - Voting eligibility logic interacts with GM; ensure it matches the "GM is just a player in VOTING" rule.

7. `app/domain/lifecycle/handlers.py`
   - `create_room` sets `gm_pid=None` (correct), but any logic that assumes creator == GM should be avoided here.


---

## VS Project Flow (Simple)

1. Players connect and join the room.
2. Any player triggers `start_role_pick` when min 5 players are connected.
3. Server assigns GM and auto-splits teams A/B (GM excluded).
4. Room moves to `CONFIG`.
5. GM sends `start_round` with secret word and timing.
6. Phase `DRAW`: drawers send `draw_op` (budget enforced).
7. Phase `GUESS`: each team submits one guess per phase.
8. If correct guess, round ends. If not, move to `VOTING`.
9. All active players vote. YES -> `ROLE_PICK` (new roles). NO/tie -> `ROUND_END`.

## Developer Terms (VS)

**Team**
- Two teams A and B, stored as sets in Redis.

**Drawer / Guesser**
- One drawer per team, others are guessers.

**Sabotage**
- Drawer-only action that draws on opponent canvas, costs 1 stroke, has cooldown, disabled in last 30s.

**Budget**
- Per-team stroke budget per DRAW phase, enforced server-side.

**Phase**
- `DRAW` -> `GUESS` -> `VOTING` and repeat.
