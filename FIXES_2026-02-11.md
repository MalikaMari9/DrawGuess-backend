# DrawGuess Backend Fixes (2026-02-11)

This document captures the changes made to integrate SINGLE mode and modularize shared logic.

## Summary
- Added SINGLE mode handlers (config, start game, draw, guess, phase tick, vote).
- Added domain helpers for role pick and voting.
- Unified secret-word redaction to show only GM + drawer.
- Extended protocols and dispatcher for SINGLE message types.
- Modularized VS voting to reuse shared vote logic.
- Modularized SINGLE handlers to mirror VS layout.
- Added SINGLE unit tests.
- Added pytest async support for SINGLE tests.
- Added dev panel controls in frontend for SINGLE/VS testing.
- Added roles_assigned mode field for consistent client handling.
- Added reconnect support for stable pid across refresh.
- Resolved merge conflict in frontend App.jsx and preserved dev panel + VS UI.
- Implemented VS auto-team assignment and disabled manual set_team.
- Added shared draw-op validation for SINGLE/VS and unit tests.
- Fixed sabotage validation order (validate before budget/cooldown).
- Ensured GM is cleared from team membership when assigned/rotated.
- Added explicit NOT_SINGLE errors in SINGLE handlers for wrong mode.
- Added pytest pythonpath config for `app.*` imports.
- Added atomic Redis budget/cooldown enforcement for VS draw/sabotage.
- Added SINGLE time-limit enforcement to end rounds on timeout.
- Added repo-level guard to prevent GM from being assigned to teams.
- Added SINGLE draw auto-split enforcement and timeout snapshot refresh.
- Added VS round time-limit enforcement and GUESS -> DRAW loop.
- Added VS action guards when round time limit has passed.
- Added GM end_round command and role clearing on entering VOTING.
- Added budget update on VS GUESS auto-expire back to DRAW.
- Allowed SINGLE guesses during DRAW phase.

## Code Changes (What and Where)

1. `app/domain/helpers/role_pick.py`
   - Added `assign_single_roles(...)` to assign GM/drawer/guesser roles for SINGLE.

2. `app/domain/helpers/voting.py`
   - Added `record_vote_all_active(...)` to normalize votes and rebuild yes-vote set.

3. `app/domain/lobby/handlers.py`
   - SINGLE: auto-assigns GM/drawer/guessers using helper.
   - SINGLE min players set to 3.

4. `app/domain/single/handlers.py`
   - Implemented SINGLE flow:
     - `set_round_config`, `start_game`, `draw_op`, `guess`, `phase_tick`, `vote_next`.
   - Correct guess ends round -> `ROUND_END` + `VOTING`.
   - Voting uses all active players; yes -> `ROLE_PICK` for new round.

5. `app/transport/protocols.py`
   - Added SINGLE inputs: `set_round_config`, `start_game`.
   - Added `guess_chat` outgoing event.
   - Expanded `roles_assigned` payload to allow SINGLE role data.

6. `app/transport/dispatcher.py`
   - Routed SINGLE messages to handlers.
   - Routed `draw_op`, `guess`, `phase_tick`, `vote_next` by room mode.

7. `app/domain/lifecycle/handlers.py`
   - Snapshot redaction now allows GM + drawer to see `secret_word`.
   - Added viewer-aware snapshot building.

8. `app/domain/vs/handlers_vote.py`
   - Uses shared vote helper to keep voting logic consistent.

9. `app/domain/single/handlers_*.py`
   - Split SINGLE handlers into config/start/draw/guess/phase/vote modules.
   - Added aggregator `app/domain/single/handlers.py`.

10. `tests/test_single_flow.py`
   - Added unit tests for SINGLE guess, phase tick, and voting.

11. `requirements.txt`, `pytest.ini`, `HOW_TO_RUN_TESTS.md`
   - Added `pytest-asyncio` and configured pytest for async tests.

12. `app/transport/protocols.py`
   - `OutRolesAssigned` now includes `mode` to disambiguate role payloads.

13. `app/domain/lobby/handlers.py`, `app/domain/vs/handlers_start_round.py`, `app/domain/vs/handlers_role_pick.py`
   - Updated roles_assigned events to include `mode`.

14. `app/domain/single/handlers_vote.py`
   - Emits a snapshot after vote resolution to keep clients in sync.

15. `tests/test_single_config_start.py`, `tests/test_single_vote_outcome.py`
   - Added SINGLE tests for config/start and vote outcomes.

16. `app/transport/protocols.py`, `app/transport/ws.py`, `app/transport/dispatcher.py`
   - Added `reconnect` message + `hello` event for stable pid handling.

17. `app/domain/lifecycle/handlers.py`, `app/transport/ws_manager.py`
   - Implemented reconnect handler and websocket pid remap.

18. `DrawGuessFrontend/src/App.jsx`, `DrawGuessFrontend/src/ws/useRoomWS.js`
   - Persisted pid/room/name in localStorage and auto-reconnect on refresh.

19. `app/domain/lobby/handlers.py`
   - VS teams auto-assigned on role pick; manual `set_team` returns `AUTO_TEAMS`.

20. `app/domain/common/ops.py`
   - Added shared draw-op validation helper (`validate_draw_op`).

21. `app/domain/single/handlers_draw.py`, `app/domain/vs/handlers_draw.py`
   - Reused shared draw-op validation in SINGLE and VS draw handlers.

22. `app/domain/vs/handlers_sabotage.py`
   - Validate sabotage operation before consuming budget/cooldown.

23. `app/store/redis_repo.py`, `app/domain/lobby/handlers.py`, `app/domain/vs/handlers_vote.py`
   - Added `clear_team(...)` and used it when assigning/rotating GM.

24. `app/domain/single/handlers_*.py`
   - Return `NOT_SINGLE` errors when called in wrong mode.

25. `tests/test_ops_validation.py`
   - Added unit tests for draw-op validation.

26. `pytest.ini`
   - Added `pythonpath = .` for test imports.

27. `app/store/redis_repo.py`, `app/domain/vs/handlers_draw.py`, `app/domain/vs/handlers_sabotage.py`
   - Added atomic budget/cooldown enforcement via Redis Lua scripts.

28. `app/domain/lifecycle/handlers.py`, `app/domain/single/handlers_*.py`
   - Auto-expire SINGLE rounds when `round_end_at` passes (transition to `ROUND_END` + `VOTING`).

29. `tests/test_single_flow.py`
   - Added timeout test for SINGLE round end.

30. `app/store/redis_repo.py`, `app/domain/lobby/handlers.py`
   - Added GM guard in `set_team` to prevent assigning GM to a team.

31. `tests/test_team_guard.py`
   - Added unit test for the GM team-assignment guard.

32. `app/domain/lifecycle/handlers.py`, `app/domain/single/handlers_draw.py`
   - Refresh snapshot header after SINGLE timeout; enforce long-stroke limits in SINGLE.

33. `tests/test_single_flow.py`
   - Added test for rejecting long SINGLE strokes.

34. `app/domain/lifecycle/handlers.py`, `app/domain/vs/handlers_phase.py`, `app/domain/vs/handlers_guess.py`, `app/domain/vs/handlers_common.py`
   - VS guess expiry returns to DRAW; VS rounds now end on round time limit.

35. `app/domain/vs/handlers_draw.py`, `app/domain/vs/handlers_guess.py`, `app/domain/vs/handlers_phase.py`
   - Block VS actions after round time limit passes.

36. `app/transport/protocols.py`, `app/transport/dispatcher.py`, `app/domain/common/end_round.py`
   - Added GM-only `end_round` message to force round end into VOTING.

37. `app/domain/common/roles.py`, `app/domain/single/handlers_guess.py`, `app/domain/vs/handlers_guess.py`, `app/domain/lifecycle/handlers.py`
   - Clear roles for all players on entering VOTING (correct guess, timeout, or GM end).

38. `tests/test_end_round.py`, `tests/test_single_flow.py`
   - Added tests for GM end_round and role clearing on correct guess.

39. `app/domain/lifecycle/handlers.py`
   - Emit budget update when VS GUESS auto-expires into DRAW.

40. `app/domain/single/handlers_guess.py`, `tests/test_single_flow.py`
   - Allow SINGLE guesses during DRAW; added test.

## Behavior Notes
- GM is assigned during role pick.
- Any player can trigger the initial role pick once minimum players are met.
- SINGLE now uses explicit phases (DRAW/GUESS/VOTING).
- All active players vote in VOTING (GM included).
