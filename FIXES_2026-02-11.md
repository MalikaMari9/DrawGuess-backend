# DrawGuess Backend Fixes (2026-02-11)

This document captures the changes made to integrate SINGLE mode and modularize shared logic.

## Summary
- Added SINGLE mode handlers (config, start game, draw, guess, phase tick, vote).
- Added domain helpers for role pick and voting.
- Unified secret-word redaction to show only GM + drawer.
- Extended protocols and dispatcher for SINGLE message types.
- Modularized VS voting to reuse shared vote logic.
- Modularized SINGLE handlers to mirror VS layout.
- Added SINGLE unit tests.
- Added pytest async support for SINGLE tests.
- Added dev panel controls in frontend for SINGLE/VS testing.
- Added roles_assigned mode field for consistent client handling.
- Added reconnect support for stable pid across refresh.
- Resolved merge conflict in frontend App.jsx and preserved dev panel + VS UI.

## Code Changes (What and Where)

1. `app/domain/helpers/role_pick.py`
   - Added `assign_single_roles(...)` to assign GM/drawer/guesser roles for SINGLE.

2. `app/domain/helpers/voting.py`
   - Added `record_vote_all_active(...)` to normalize votes and rebuild yes-vote set.

3. `app/domain/lobby/handlers.py`
   - SINGLE: auto-assigns GM/drawer/guessers using helper.
   - SINGLE min players set to 3.

4. `app/domain/single/handlers.py`
   - Implemented SINGLE flow:
     - `set_round_config`, `start_game`, `draw_op`, `guess`, `phase_tick`, `vote_next`.
   - Correct guess ends round -> `ROUND_END` + `VOTING`.
   - Voting uses all active players; yes -> `ROLE_PICK` for new round.

5. `app/transport/protocols.py`
   - Added SINGLE inputs: `set_round_config`, `start_game`.
   - Added `guess_chat` outgoing event.
   - Expanded `roles_assigned` payload to allow SINGLE role data.

6. `app/transport/dispatcher.py`
   - Routed SINGLE messages to handlers.
   - Routed `draw_op`, `guess`, `phase_tick`, `vote_next` by room mode.

7. `app/domain/lifecycle/handlers.py`
   - Snapshot redaction now allows GM + drawer to see `secret_word`.
   - Added viewer-aware snapshot building.

8. `app/domain/vs/handlers_vote.py`
   - Uses shared vote helper to keep voting logic consistent.

9. `app/domain/single/handlers_*.py`
   - Split SINGLE handlers into config/start/draw/guess/phase/vote modules.
   - Added aggregator `app/domain/single/handlers.py`.

10. `tests/test_single_flow.py`
   - Added unit tests for SINGLE guess, phase tick, and voting.

11. `requirements.txt`, `pytest.ini`, `HOW_TO_RUN_TESTS.md`
   - Added `pytest-asyncio` and configured pytest for async tests.

12. `app/transport/protocols.py`
   - `OutRolesAssigned` now includes `mode` to disambiguate role payloads.

13. `app/domain/lobby/handlers.py`, `app/domain/vs/handlers_start_round.py`, `app/domain/vs/handlers_role_pick.py`
   - Updated roles_assigned events to include `mode`.

14. `app/domain/single/handlers_vote.py`
   - Emits a snapshot after vote resolution to keep clients in sync.

15. `tests/test_single_config_start.py`, `tests/test_single_vote_outcome.py`
   - Added SINGLE tests for config/start and vote outcomes.

16. `app/transport/protocols.py`, `app/transport/ws.py`, `app/transport/dispatcher.py`
   - Added `reconnect` message + `hello` event for stable pid handling.

17. `app/domain/lifecycle/handlers.py`, `app/transport/ws_manager.py`
   - Implemented reconnect handler and websocket pid remap.

18. `DrawGuessFrontend/src/App.jsx`, `DrawGuessFrontend/src/ws/useRoomWS.js`
   - Persisted pid/room/name in localStorage and auto-reconnect on refresh.

## Behavior Notes
- GM is assigned during role pick.
- Any player can trigger the initial role pick once minimum players are met.
- SINGLE now uses explicit phases (DRAW/GUESS/VOTING).
- All active players vote in VOTING (GM included).
